#!/usr/bin/env bash
# Verifies the correctness of the concurrent implementation of carcara comparing
#  the result generated by the single thread execution and a parallel execution.
# Receives a single argument that is the directory path that contains the files 
#  to be used in the test

DIR=$1

aaa=$(pwd);
FULL_DIR="$aaa/$DIR";
echo $FULL_DIR;
cd $FULL_DIR
count=0

for FILE in *.smt_in; do
    RESULT1=$(cargo run -- check --skip-unknown-rules -u 1 "$FILE.proof" "$FILE" 2>/dev/null);
    RESULT2=$(cargo run --features thread-safety -- check --skip-unknown-rules -u 3 "$FILE.proof" "$FILE" 2>/dev/null);

    RESULT1=$(echo $RESULT1 | tr '\a' ' ' | awk '{print $NF}')
    RESULT2=$(echo $RESULT2 | tr '\a' ' ' | awk '{print $NF}')

    DIF="EQUAL"
    if [ "$RESULT1" != "$RESULT2" ]; then
        DIF="DIF"
        ((count = count + 1))
        echo $''$FILE$': '$RESULT1$' is \e[1;31m'$DIF$'\e[0m from '$RESULT2$'';
    else
        echo $''$FILE$': '$RESULT1$' is \e[1;32m'$DIF$'\e[0m from '$RESULT2$'';
    fi
done

echo;
echo "Different count: $count";